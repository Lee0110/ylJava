# 即使消息学习笔记

## 1. IM的特性

### 实时性

- 短轮询->长轮询->全双工WebSocket->TCP长连接

### 可靠性

- 保证不丢消息、消息不重复
- 如何做到：
  1. 业务层的 ACK 确认和重传机制，能解决大部分推送过程中消息丢失的情况
  2. 客户端的去重机制，屏蔽掉重传过程中可能导致消息重复的问题
  3. 完整性检查机制来及时发现消息丢失的情况并进行补推修复，消息完整性检查可以通过时间戳比对，或者全局自增序列等方式来实现。

### 一致性

- 一般来说是时序一致性
- 需要找到一个时序基准来标识每一条消息的顺序
- 这个时序基准可以通过全局的序号生成器来确定。常见的实现方式：支持单调自增序号的资源生成，分布式时间相关的 ID 生成服务生成
- 通过“服务端包内整流”机制来保证需要“严格有序”批量消息的正确执行；或者，接收方根据消息序号来进行消息本地整流，从而确保多接收方的最终一致性

### 安全性

- 消息传输安全性：
  - 访问入口安全：HttpDNS
  - 链路传输安全：
    - 多通道
    - 使用私有协议代替JSON、XML、HTTP等
    - TLS传输层加密协议
- 消息存储安全性：
  - 账号密码存储安全：单向散列算法、加盐
  - 消息内容存储安全：端到端加密(通信双方各自生成秘钥对并进行公钥的交换，私钥各自保存在本地不给到 IM 服务端)
- 消息内容安全性
  - 建立敏感词库，针对文字内容进行安全识别
  - 依托图片识别技术来对色情图片和视频、广告图片、涉政图片等进行识别处置
  - 使用“语音转文字”和 OCR（图片文本识别）来辅助对图片和语音的进一步挖掘识别
  - 通过爬虫技术来对链接内容进行进一步分析，识别“风险外链”

## 2. 消息未读数不一致怎么解决

- 分布式锁：具备较好普适性，但执行效率较差，锁的管理也比较复杂，适用于较小规模的即时消息场景；
- 支持事务功能的资源：不需要额外的维护锁的资源，实现较为简单，但基于乐观锁的 watch 机制在较高并发场景下失败率较高，执行效率比较容易出现瓶颈；
- 原子化嵌入脚本：不需要额外的维护锁的资源，高并发场景下性能也较好，嵌入脚本的开发需要一些额外的学习成本。

## 3. 心跳机制

- TCP Keepalive
- 应用层心跳